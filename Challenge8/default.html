<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Challenge8 - Group1</title>
    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
    <script src="http://hhao.hostei.com/doc/files/CDN/jr.js"></script>
  </head>
  <body>
  <style>
    body{
      background-image: url("http://hhao.hostei.com/doc/hao_hu_601termproject/img/bg.png");
      background-repeat: repeat;
    }

    p.red{
      color:#cc0000;
      font-family:sans-serif;
      font-weight:bold;
      margin-left:60px;
      font-size:22px;
      margin-bottom:5px;
      margin-top:10px;
    }

    .input-text{ border:#9f9f9f solid 1px; width:90px;color:#19a5c8; padding: 6px 18px;margin:8px 6px;}
    p.gray{	color:#646464; margin-left:60px;	margin-top:3px;margin-bottom:3px}

    .ins{color:#646464; margin-left:60px;margin-top:5px}
    #info{display:block;}
    #msg{display:none; position:absolute; top:40px; width:30%;border-radius: 5px;margin-left:35%;background-color: #646464;color:#ffffff;display:block;opacity:0.8}
    #msg>p{margin:8px 12px;margin-left: 15px}
    #myCanvas{margin-left: 62px;width: 1020px;border:1px solid #d3d3d3;}
    #control_panel{background-color: #646464; height:200px;width:200px;border-radius:100px;opacity:0.35;left:40%;top:40%;
    position:absolute;}

    #b_u{margin-left:60px;margin-top: 10px}
    #b_d{margin-left:60px;margin-top:-5px}
    #b_l{margin-left:10px;}
    #b_r{}
    #b_s{color:#ffffff;background-color:#ff4848 ;width:75px; height:75px;border: #ff4848 solid 0px;
         margin-top: -65px;vertical-align: text-top;border-radius: 8px; -webkit-appearance: none;-moz-appearance: none;appearance: none;}
    #b_u:hover,#b_d:hover,#b_l:hover,#b_r:hover,#b_s:hover{cursor:pointer}
    #setPoint{
      	-webkit-appearance: none;
         	-moz-appearance: none;
         	appearance: none;
      	font-family:Calibri;
      	font-size:14px;
      	padding:6px 18px;
      	color: #ffffff;
      	background-color:#646464;
      	border: #646464 solid 1px;
      	border-radius:4px;
      	width:150px;
      	box-shadow: 0 1px gray;
    }
    #setPoint:hover{cursor:pointer;opacity: 0.8}
    #monitor{position:absolute; right:20px; top: 15px;opacity:0.9}
    iframe{border: #ffffff solid 3px; border-radius: 5px;}
    #hide{position:absolute; right:20px; top: 15px;opacity:0.9;border: #ffffff solid 3px;
          border-radius: 5px;color: #ffffff; background-color:#646464;cursor:pointer;}
    #video:hover{opacity:0.6}
    #car:hover{opacity:0.6;cursor:pointer;}
  </style>


  <script>
  /*len & hei are the drawing square inside the canvas*/
  var len = 980-19; // values are hard coded
  var hei = 406-15; // values are hard coded
  var hor = $("#x").val();
  var ver = $("#y").val();
  var grid = hei/hor;
  var posData = [];
  var isSetPoint = false; //if set start point button clicked
  var hasStartPoint =false;// have set the start point?
  var keyPressArray =[];   // collect the key pressed in 50 milliseconds
  var preValue =[0,0,0,0];

  function updateGraph(){
    hor = $("#x").val();
    ver = $("#y").val();
    grid = hei/hor;
    /*clear*/
    var canvas = document.getElementById("myCanvas");
    var chart = canvas.getContext("2d");
    chart.clearRect(0, 0, canvas.width, canvas.height);

    /*boundary*/
    var c = document.getElementById("myCanvas");
    var chart = c.getContext("2d");
    var img = document.getElementById("layout");
    chart.drawImage(img, 0, 0);
    drawGrid(hor,ver,grid);

    /*draw path*/
    for(i = 0; i < posData.length-1; i++){ // last point is the cur position
      drawPath( posData[i], posData[i+1]);
    }

    /*draw cur position*/
    //chart.drawImage(img, 0, 0); //draw layout, not sure about the place
    var pos = document.getElementById("picCar");
    var cen = document.getElementById("cen");
    if(posData.length > 0){
      var curX = Math.ceil((parseFloat(posData[posData.length-1].Y) + 0.5) * grid + 45); //convert to canvas value
      var curY = Math.ceil((parseFloat(posData[posData.length-1].X) + 0.5) * grid + 30); //convert to canvas value
      chart.drawImage(cen, curX - cen.width/2, curY - cen.height/2); //draw pos
      chart.drawImage(pos, curX - pos.width/2, curY - pos.height/2 - 10); //draw pos
    }

    turnAMT(1,1);
  }
  /*  if(posData.length = 1){
      var curX = Math.ceil((parseFloat(posData[posData.length-1].Y) + 0.5) * grid + 45); //convert to canvas value
      var curY = Math.ceil((parseFloat(posData[posData.length-1].X) + 0.5) * grid + 30); //convert to canvas value
      chart.drawImage(cen, curX - cen.width/2, curY - cen.height/2); //draw pos
      chart.drawImage(pos, curX - pos.width/2, curY - pos.height/2 - 10); //draw pos
    }else if(posData.length > 1){
        draw();
        console.log("yes");
    }


    function draw(){
        chart.save();
        var lenX = parseFloat(posData[posData.length-1].X) - parseFloat(posData[posData.length-2].X);
        var lenY = parseFloat(posData[posData.length-1].Y) - parseFloat(posData[posData.length-2].Y);
        var cot =  lenX/lenY;
        var shortX = (lenX/10 * (time.getMilliseconds() % 10 + 1)).toFixed(2);
        var shortY = (shortX / cot).toFixed(2);
        var curJson = {"X":parseFloat(posData[posData.length-2].X) + shortX,"Y":parseFloat(posData[posData.length-2].Y) + shortY};
        drawPath(posData[posData.length-2],curJson);
        var curX = Math.ceil((parseFloat(curJson.Y) + 0.5) * grid + 45); //convert to canvas value
        var curY = Math.ceil((parseFloat(curJson.X) + 0.5) * grid + 30); //convert to canvas value
        chart.drawImage(cen, curX - cen.width/2, curY - cen.height/2); //draw pos
        chart.drawImage(pos, curX - pos.width/2, curY - pos.height/2 - 10); //draw pos
        window.requestAnimationFrame(draw);
    }
  }*/

  /*functions that updateGraph used*/
  function drawGrid(hor,ver,d){
    /*Relative value for diff resolution*/
    var canvas = document.getElementById("myCanvas");
    var chart = canvas.getContext("2d");

    /*Draw Ver line*/
    chart.fillStyle="#636363";
    chart.strokeStyle = "rgba(163,212,214,0.4)";
    chart.lineWidth=1;
    chart.beginPath();
    chart.stroke();
    for(i = 0; i * d < len; i++){
      chart.moveTo(i*d+19,15);
      chart.lineTo(i*d+19,15+hei);
    }
    chart.stroke();

    //Draw Hor line
    chart.strokeStyle="rgba(70,70,70,0.1)";
    chart.lineWidth=1;
    chart.beginPath();
    for(i = 0; i < ver; i++){
      chart.moveTo(19,i*d+15);
      chart.lineTo(19+len,i*d+15);
    }
    chart.stroke();
  }

  function drawPath(p1,p2){
  	  var canvas = document.getElementById("myCanvas");
  	  var chart = canvas.getContext("2d");

  		var x1 = Math.ceil((parseFloat(p1.Y)+0.5)*grid+45) ; //x1 is the time line position
  		var x2 = Math.ceil((parseFloat(p2.Y)+0.5)*grid+45) ; //x2 is the time line position
  		var y1 = Math.ceil((parseFloat(p1.X)+0.5)*grid+30) ; //y1 is the temp1 line position
  		var y2 = Math.ceil((parseFloat(p2.X)+0.5)*grid+30) ; //y2 is the temp1 line position

      /*Draw Line*/
      chart.strokeStyle = "rgba(252,233,18,1)";
      chart.lineWidth = 2;
      chart.beginPath();
      chart.moveTo(x1,y1);
      chart.lineTo(x2,y2);
      chart.closePath();
      chart.stroke();

    		/*Draw point1*/
        chart.fillStyle = "rgba(252,233,18,1)";
        chart.lineWidth = 2;
    		chart.beginPath();
    		chart.arc(x1, y1, 3, 0, 2 * Math.PI);
        chart.closePath();
    		chart.fill();

    		/*Draw point2*/
        chart.lineWidth = 2;
    		chart.beginPath();
    		chart.arc(x2, y2, 3, 0, 2 * Math.PI);
        chart.closePath();
    		chart.fill();
  }

  function lineAMT(p1,p2){ // straight animation
  }

  function turnAMT(flag){//flag = 0 turn left, flag = 1 turn right
    if(flag == 0){//turn left
        $("#car").rotate({
          duration:2000,
          angle: 0,
          animateTo:90
        })
    }else{ //turn right
        $("#car").rotate({
          duration:2000,
          angle: 0,
          animateTo:-90
        })
    }

  }

  /*------------end-----------*/


  function setstartPoint(){
    var canvas = document.getElementById("myCanvas");
    canvas.addEventListener("mousedown", getPosition, false);
  }

  function con(val,p){//convert to canvas value;
    var canvas = document.getElementById('myCanvas');
    var rect = canvas.getBoundingClientRect();
    var result = (p==0)? val-17 +rect.left:val-5+rect.top;
    return result;
  }

  function getPosition(event)
    {
      if(isSetPoint == true && hasStartPoint == false){
        var canvas = document.getElementById("myCanvas");
        var chart = canvas.getContext("2d");
        var startFlag = document.getElementById("flag");
        var rect = canvas.getBoundingClientRect();
        var x = event.clientX - rect.left;
        var y = event.clientY - rect.top;
        x = (x - x % grid) + 17 + grid/2; //format
        y = (y - y % grid) + 5 + grid/2; //format
        chart.drawImage(startFlag, x, y);
        $("#car").css({"display":"block","position":"absolute","top":con(y,1),"left":con(x,0)});
        hasStartPoint = true; //flag setted
      }
    }

  /*function getData(){
    var rawData;
    $.when(
      $.ajax({
          url: "/startMapping",
          type: 'GET',
          async: false,
          cache: false,
          timeout: 10000,
          error: function(msg){
              $("#msg").html("<p>Server : Update failed</p>");
              $("#msg>p").css({"margin":"8px 12px","margin-left": "15px"});
              $("#msg").fadeIn(500);
          },
          success: function(msg){
            if(typeof(msg) == "object" && !(typeof(msg.msg) === 'undefined')){ // no sensor
                $("#msg").html("<p>Server:" + msg.msg+"</p>");
                $("#msg>p").css({"margin":"8px 12px","margin-left": "15px"});
                $("#msg").fadeIn(500);
            }
                rawData = msg;
          }
      })
    ).then(function() {
      var newData = cleanData(rawData);
      if(posData.length < 100){ //only keep most 100 data
          posData.push(newData);
          console.log("Get pos X:"+newData.X + ", Y:" + newData.Y);
          updateGraph();
      }else{
          posData.splice(0,1);
          posData.push(newData);
          console.log("Get pos X:"+newData.X + ", Y:" + newData.Y);
          updateGraph();
      }
    });

  }*/



  function drive(u,d,l,r){
    var rawData;
    var URLString = "/drive?u=" + u +"&d="+ d +"&l="+ l +"&r="+ r ;
      $.when(
        $.ajax({
            url: URLString,
            dataType: 'json',
            async: false,
            cache: false,
            timeout: 10000,
            error: function(msg){
                $("#msg").html("<p>Server : Drive signal send failed</p>");
            },
            success: function(msg){
              $("#msg").html("<p>"+msg.msg+"</p>");
              $("#msg").fadeIn(500);
            }
        })
      ).then(function() {
        //update canvas
      });
    }

    function begin(){
      var rawData;
        $.when(
          $.ajax({
              url: "/start",
              type: 'GET',
              async: false,
              cache: false,
              timeout: 10000,
              error: function(msg){
                  $("#msg").html("<p>Server : Start failed</p>");
              },
              success: function(msg){
                $("#msg").html("<p>"+msg.msg+"</p>");
                $("#msg").fadeIn(500);
              }
          })
        ).then(function() {
          //update canvas
        });
    }


    function end(){
      var rawData;
        $.when(
          $.ajax({
              url: "/stop",
              type: 'GET',
              async: false,
              cache: false,
              timeout: 10000,
              error: function(msg){
                  $("#msg").html("<p>Server : Stop failed</p>");
              },
              success: function(msg){
                $("#msg").html("<p>"+msg.msg+"</p>");
                $("#msg").fadeIn(500);
              }
          })
        ).then(function() {
          //update canvas
        });
    }

    function sendCommand(){
      var u,d,l,r, count = 0;
      u = (keyPressArray[87] || keyPressArray[38])? 1:0;
      d = (keyPressArray[83] || keyPressArray[40])? 1:0;
      l = (keyPressArray[65] || keyPressArray[37])? 1:0;
      r = (keyPressArray[68] || keyPressArray[39])? 1:0;

      count =  parseInt(u)+parseInt(d)+parseInt(l)+parseInt(r);
      if(count != 0 && (preValue[0]!=u || preValue[1]!=d || preValue[2]!=l || preValue[3]!=r ) ){
        drive(u,d,l,r);
        console.log(" | U: "+u+" | D: "+d+" | L: "+l+" | R: "+r);
        preValue[0] = u;
        preValue[1] = d;
        preValue[2] = l;
        preValue[3] = r;
      }//there are keys pressed
      setTimeout(sendCommand, 5);
    }

  //layout position: (45,30) - (848,392)
  window.onload = function() {
      updateGraph();
  }

  $( document ).ready(function() {
     //setInterval(getData, 12000); //update every 12 secs
     $("#car").click(function(){
        turnAMT(1,1);
     });

     $(".button").hover(function(){
			$(this).stop().animate({
				opacity:"0.4"
				},300);
			},function(){
				$(this).stop().animate({
				      opacity:"1"
			  }, 300);
      });

      $("#control_panel").hover(function(){
 			    $(this).stop().animate({
 				       opacity:"1"
 				        },300);
 			    },function(){
 				             $(this).stop().animate({
 				                  opacity:"0.35"
 			               }, 800);
	        })

      $("#setPoint").click(function(){
        isSetPoint = true;//set the start point by clicking on canvas
      });
      $( "#hide" ).click(function() {
        $( "#video" ).toggle("slow");
      });

      document.addEventListener('keydown', function(e) { //add keydown listener
         keyPressArray[e.keyCode] = true;
         if(keyPressArray[87] || keyPressArray[38]) $("#b_u").stop().mouseover();
         if(keyPressArray[83] || keyPressArray[40]) $("#b_d").stop().mouseover();
         if(keyPressArray[65] || keyPressArray[37]) $("#b_l").stop().mouseover();
         if(keyPressArray[68] || keyPressArray[39]) $("#b_r").stop().mouseover();
      }, false);

      document.addEventListener('keyup', function(e) { //add keyup listener
         keyPressArray[e.keyCode] = false;
         if(!keyPressArray[87] || !keyPressArray[38]) {drive(0,0,0,0);$("#b_u").stop().mouseout();}
         if(!keyPressArray[83] || !keyPressArray[40]) {drive(0,0,0,0);$("#b_d").stop().mouseout();}
         if(!keyPressArray[65] || !keyPressArray[37]) $("#b_l").stop().mouseout();
         if(!keyPressArray[68] || !keyPressArray[39]) $("#b_r").stop().mouseout();
      }, false);

          /*button press functions */
          $("#b_u").click(function(){
            drive(1,0,0,0);
            console.log("Up button clicked");
          });

          $("#b_d").click(function(){
            drive(0,1,0,0);
            console.log("Down button clicked");
          });

          $("#b_l").click(function(){
            drive(0,0,1,0);
            console.log("Left button clicked");;
          });

          $("#b_r").click(function(){
            drive(0,0,0,1);
            console.log("Right button clicked");
          });

          $("#b_s").click(function(){
            if($("#b_s").val() == "Start"){
              $("#b_s").val("Stop");
              begin();
            }else{
              $("#b_s").val("Start");
              end();
            }
            console.log("Control");
          });

  });

  document.addEventListener("DOMContentLoaded", setstartPoint, false);
  window.setInterval(sendCommand, 50);
  </script>


      <div id = "info">
        <p class="red" >Boston University</p>
        <p class="gray" >GROUP 1, Challenge 8</p>
        <p class="gray" >Pete, Carlos, Hao, Avi, Ying</p>
      <br/>
      </div>
      <div  id="msg"></div>
      <canvas id="myCanvas"  width="1020px" height="420px">
        Your browser does not support the HTML5 canvas tag.</canvas>
      <div class="canvas">
      <p class="ins">
      Start Point: <img id="flag" src="http://hhao.hostei.com/doc/files/CDN/flag.png"/>&nbsp;
      Car: <img id="picCar" src="http://hhao.hostei.com/doc/files/CDN/car.png" style="vertical-align: middle"/>&nbsp;
        X:<input id="x" class="input-text" type="text" value="8">&nbsp;
        Y:<input id="y" class="input-text" type="text" value="15">&nbsp;
        <input id="setPoint" class="button" type="submit" value="Set Start Point">&nbsp;
      </p>
      </div>
      <div id = "control_panel">
        <img id= "b_u" class="button" src="http://hhao.hostei.com/doc/files/CDN/up.png" alt="up"/><br/>
        <img id= "b_l" class="button" src="http://hhao.hostei.com/doc/files/CDN/left.png" alt="down"/>
        <input id="b_s" class="button" type="submit" value="Start">
        <img id= "b_r" class="button" src="http://hhao.hostei.com/doc/files/CDN/right.png" alt="left"/>
        <img id= "b_d" class="button" src="http://hhao.hostei.com/doc/files/CDN/down.png" alt="right"/><br/>
      </div>


      <div id="monitor">
        <iframe id="video" src="http://192.168.2.149:8081" style="width: 320px; height: 240px"></iframe>
      </div>
      <input id="hide" class="button" type="submit" value="Hide">

      <img id="layout" src="http://hhao.hostei.com/doc/files/CDN/layout.png" style="display:none;"/>
      <img id="cen" src="http://hhao.hostei.com/doc/files/CDN/cen.png" style="display:none;"/>
      <img id="car" src="http://hhao.hostei.com/doc/files/CDN/car.png" style="display:none"/>

  </body>
</html>
