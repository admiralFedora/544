<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Challenge8 - Group1</title>
    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
  </head>
  <body>
  <style>
    body{
      background-image: url("http://hhao.hostei.com/doc/hao_hu_601termproject/img/bg.png");
      background-repeat: repeat;
    }

    p.red{
      color:#cc0000;
      font-family:sans-serif;
      font-weight:bold;
      margin-left:60px;
      font-size:22px;
      margin-bottom:5px;
      margin-top:10px;
    }

    .input-text{ border:#9f9f9f solid 1px; width:90px;color:#19a5c8; padding: 6px 18px;margin:8px 6px;}
    p.gray{	color:#646464; margin-left:60px;	margin-top:3px;margin-bottom:3px}

    .ins{color:#646464; margin-left:60px;margin-top:5px}
    #info{display:block;}
    #msg{display:none; position:absolute; top:40px; width:30%;border-radius: 5px;margin-left:35%;background-color: #646464;color:#ffffff;display:block;opacity:0.8}
    #msg>p{margin:8px 12px;margin-left: 15px}
    #myCanvas{margin-left: 4%;width: 1020px;border:1px solid #d3d3d3;}
    #control_panel{background-color: #646464; height:200px;width:200px;border-radius:100px;opacity:0.35;left:40%;top:40%;
    position:absolute;}

    #b_u{margin-left:60px;margin-top: 10px}
    #b_d{margin-left:60px;margin-top:-5px}
    #b_l{margin-left:10px;}
    #b_r{}
    #b_s{color:#ffffff;background-color:#ff4848 ;width:75px; height:75px;border: #ff4848 solid 0px;
         margin-top: -65px;vertical-align: text-top;border-radius: 8px; -webkit-appearance: none;-moz-appearance: none;appearance: none;}
    #b_u:hover,#b_d:hover,#b_l:hover,#b_r:hover,#b_s:hover{cursor:pointer}
    #setPoint{
      	-webkit-appearance: none;
         	-moz-appearance: none;
         	appearance: none;
      	font-family:Calibri;
      	font-size:14px;
      	padding:6px 18px;
      	color: #ffffff;
      	background-color:#646464;
      	border: #646464 solid 1px;
      	border-radius:4px;
      	width:150px;
      	box-shadow: 0 1px gray;
    }
    #setPoint:hover{cursor:pointer;opacity: 0.8}
    #monitor{position:absolute; right:20px; top: 20px; width:20%; height:20%}
  </style>


  <script>
  /*len & hei are the drawing square inside the canvas*/
  var len = 980-19; // values are hard coded
  var hei = 406-15; // values are hard coded
  var hor = $("#x").val();
  var ver = $("#y").val();
  var grid = hei/hor;
  var posData = [];
  var isPointSet = true;

  function updateGraph(){
    hor = $("#x").val();
    ver = $("#y").val();
    grid = hei/hor;
    /*clear*/
    var canvas = document.getElementById("myCanvas");
    var chart = canvas.getContext("2d");
    chart.clearRect(0, 0, canvas.width, canvas.height);

    /*boundary*/
    var c = document.getElementById("myCanvas");
    var chart = c.getContext("2d");
    var img = document.getElementById("layout");
    chart.drawImage(img, 0, 0);
    drawGrid(hor,ver,grid);

    /*draw path*/
    for(i = 0; i < posData.length-1; i++){ // last point is the cur position
      drawPath( posData[i], posData[i+1]);
    }

    /*draw cur position*/
    //chart.drawImage(img, 0, 0); //draw layout, not sure about the place
    var pos = document.getElementById("pos");
    var cen = document.getElementById("cen");
    if(posData.length > 0){
      var curX = Math.ceil((parseFloat(posData[posData.length-1].Y) + 0.5) * grid + 45); //convert to canvas value
      var curY = Math.ceil((parseFloat(posData[posData.length-1].X) + 0.5) * grid + 30); //convert to canvas value
      chart.drawImage(cen, curX - cen.width/2, curY - cen.height/2); //draw pos
      chart.drawImage(pos, curX - pos.width/2, curY - pos.height/2 - 10); //draw pos
    }
  }
  /*  if(posData.length = 1){
      var curX = Math.ceil((parseFloat(posData[posData.length-1].Y) + 0.5) * grid + 45); //convert to canvas value
      var curY = Math.ceil((parseFloat(posData[posData.length-1].X) + 0.5) * grid + 30); //convert to canvas value
      chart.drawImage(cen, curX - cen.width/2, curY - cen.height/2); //draw pos
      chart.drawImage(pos, curX - pos.width/2, curY - pos.height/2 - 10); //draw pos
    }else if(posData.length > 1){
        draw();
        console.log("yes");
    }


    function draw(){
        chart.save();
        var lenX = parseFloat(posData[posData.length-1].X) - parseFloat(posData[posData.length-2].X);
        var lenY = parseFloat(posData[posData.length-1].Y) - parseFloat(posData[posData.length-2].Y);
        var cot =  lenX/lenY;
        var shortX = (lenX/10 * (time.getMilliseconds() % 10 + 1)).toFixed(2);
        var shortY = (shortX / cot).toFixed(2);
        var curJson = {"X":parseFloat(posData[posData.length-2].X) + shortX,"Y":parseFloat(posData[posData.length-2].Y) + shortY};
        drawPath(posData[posData.length-2],curJson);
        var curX = Math.ceil((parseFloat(curJson.Y) + 0.5) * grid + 45); //convert to canvas value
        var curY = Math.ceil((parseFloat(curJson.X) + 0.5) * grid + 30); //convert to canvas value
        chart.drawImage(cen, curX - cen.width/2, curY - cen.height/2); //draw pos
        chart.drawImage(pos, curX - pos.width/2, curY - pos.height/2 - 10); //draw pos
        window.requestAnimationFrame(draw);
    }
  }*/

  function drawGrid(hor,ver,d){
    /*Relative value for diff resolution*/
    var canvas = document.getElementById("myCanvas");
    var chart = canvas.getContext("2d");

    /*Draw Ver line*/
    chart.fillStyle="#636363";
    chart.strokeStyle = "rgba(163,212,214,0.4)";
    chart.lineWidth=1;
    chart.beginPath();
    chart.stroke();
    for(i = 0; i * d < len; i++){
      chart.moveTo(i*d+19,15);
      chart.lineTo(i*d+19,15+hei);
    }
    chart.stroke();

    //Draw Hor line
    chart.strokeStyle="rgba(70,70,70,0.1)";
    chart.lineWidth=1;
    chart.beginPath();
    for(i = 0; i < ver; i++){
      chart.moveTo(19,i*d+15);
      chart.lineTo(19+len,i*d+15);
    }
    chart.stroke();
  }

  function drawPath(p1,p2){
  	  var canvas = document.getElementById("myCanvas");
  	  var chart = canvas.getContext("2d");

  		var x1 = Math.ceil((parseFloat(p1.Y)+0.5)*grid+45) ; //x1 is the time line position
  		var x2 = Math.ceil((parseFloat(p2.Y)+0.5)*grid+45) ; //x2 is the time line position
  		var y1 = Math.ceil((parseFloat(p1.X)+0.5)*grid+30) ; //y1 is the temp1 line position
  		var y2 = Math.ceil((parseFloat(p2.X)+0.5)*grid+30) ; //y2 is the temp1 line position

      /*Draw Line*/
      chart.strokeStyle = "rgba(252,233,18,1)";
      chart.lineWidth = 2;
      chart.beginPath();
      chart.moveTo(x1,y1);
      chart.lineTo(x2,y2);
      chart.closePath();
      chart.stroke();

    		/*Draw point1*/
        chart.fillStyle = "rgba(252,233,18,1)";
        chart.lineWidth = 2;
    		chart.beginPath();
    		chart.arc(x1, y1, 3, 0, 2 * Math.PI);
        chart.closePath();
    		chart.fill();

    		/*Draw point2*/
        chart.lineWidth = 2;
    		chart.beginPath();
    		chart.arc(x2, y2, 3, 0, 2 * Math.PI);
        chart.closePath();
    		chart.fill();
  }

  function cleanData(raw){
      var count = 0;
      var v1, v2;
      for (i = 0 ; i < raw.length; i++){
          if (i == 0) { v1 = raw[0].locx; v2 = raw[0].locy; count = 1;}    // count appeared times
          else{
            if(raw[i].locx == v1 && raw[i].locy == v2){count ++; }
            else{
              count--;
              if(count < 0){v1 = raw[i].locx; v2 = raw[i].locy; count = 1;}// reset
            }
          }
      }
      return {"X":v1,"Y":v2};
  }

  function setstartPoint(){
      if(!isPointSet){

      }
  }

  /*function getData(){
    var rawData;
    $.when(
      $.ajax({
          url: "/startMapping",
          type: 'GET',
          async: false,
          cache: false,
          timeout: 10000,
          error: function(msg){
              $("#msg").html("<p>Server : Update failed</p>");
              $("#msg>p").css({"margin":"8px 12px","margin-left": "15px"});
              $("#msg").fadeIn(500);
          },
          success: function(msg){
            if(typeof(msg) == "object" && !(typeof(msg.msg) === 'undefined')){ // no sensor
                $("#msg").html("<p>Server:" + msg.msg+"</p>");
                $("#msg>p").css({"margin":"8px 12px","margin-left": "15px"});
                $("#msg").fadeIn(500);
            }
                rawData = msg;
          }
      })
    ).then(function() {
      var newData = cleanData(rawData);
      if(posData.length < 100){ //only keep most 100 data
          posData.push(newData);
          console.log("Get pos X:"+newData.X + ", Y:" + newData.Y);
          updateGraph();
      }else{
          posData.splice(0,1);
          posData.push(newData);
          console.log("Get pos X:"+newData.X + ", Y:" + newData.Y);
          updateGraph();
      }
    });

  }*/

function up(){
  var rawData;
    $.when(
      $.ajax({
          url: "/up",
          type: 'GET',
          async: false,
          cache: false,
          timeout: 10000,
          error: function(msg){
              $("#msg").html("<p>Server : Drive forward failed</p>");
          },
          success: function(msg){
            $("#msg").html("<p>"+msg.msg+"</p>");
            $("#msg").fadeIn(500);
          }
      })
    ).then(function() {
      //update canvas
    });
}


function down(){
  var rawData;
    $.when(
      $.ajax({
          url: "/down",
          type: 'GET',
          async: false,
          cache: false,
          timeout: 10000,
          error: function(msg){
              $("#msg").html("<p>Server : Drive backward failed</p>");
          },
          success: function(msg){
            $("#msg").html("<p>"+msg.msg+"</p>");
            $("#msg").fadeIn(500);
          }
      })
    ).then(function() {
      //update canvas
    });
}


function left(){
  var rawData;
    $.when(
      $.ajax({
          url: "/left",
          type: 'GET',
          async: false,
          cache: false,
          timeout: 10000,
          error: function(msg){
              $("#msg").html("<p>Server : Turn left failed</p>");
          },
          success: function(msg){
            $("#msg").html("<p>"+msg.msg+"</p>");
            $("#msg").fadeIn(500);
          }
      })
    ).then(function() {
      //update canvas
    });
}


function right(){
  var rawData;
    $.when(
      $.ajax({
          url: "/right",
          type: 'GET',
          async: false,
          cache: false,
          timeout: 10000,
          error: function(msg){
              $("#msg").html("<p>Server : Turn right failed</p>");
          },
          success: function(msg){
            $("#msg").html("<p>"+msg.msg+"</p>");
            $("#msg").fadeIn(500);
          }
      })
    ).then(function() {
      //update canvas
    });
  }

  function drive(u,d,l,r){
    var rawData;
    var URLString = "/drive?u=" + u +"&d="+ d +"&l="+ l +"&r="+ r ;
      $.when(
        $.ajax({
            url: URLString,
            dataType: 'json',
            async: false,
            cache: false,
            timeout: 10000,
            error: function(msg){
                $("#msg").html("<p>Server : Turn right failed</p>");
            },
            success: function(msg){
              $("#msg").html("<p>"+msg.msg+"</p>");
              $("#msg").fadeIn(500);
            }
        })
      ).then(function() {
        //update canvas
      });
    }

    function begin(){
      var rawData;
        $.when(
          $.ajax({
              url: "/start",
              type: 'GET',
              async: false,
              cache: false,
              timeout: 10000,
              error: function(msg){
                  $("#msg").html("<p>Server : Start failed</p>");
              },
              success: function(msg){
                $("#msg").html("<p>"+msg.msg+"</p>");
                $("#msg").fadeIn(500);
              }
          })
        ).then(function() {
          //update canvas
        });
    }


    function end(){
      var rawData;
        $.when(
          $.ajax({
              url: "/stop",
              type: 'GET',
              async: false,
              cache: false,
              timeout: 10000,
              error: function(msg){
                  $("#msg").html("<p>Server : Stop failed</p>");
              },
              success: function(msg){
                $("#msg").html("<p>"+msg.msg+"</p>");
                $("#msg").fadeIn(500);
              }
          })
        ).then(function() {
          //update canvas
        });
    }

  //layout position: (45,30) - (848,392)
  window.onload = function() {
      updateGraph()
  }

  $( document ).ready(function() {
     //setInterval(getData, 12000); //update every 12 secs

     $(".button").hover(function(){
			$(this).stop().animate({
				opacity:"0.4"
				},300);
			},function(){
				$(this).stop().animate({
				      opacity:"1"
			  }, 300);
      });

      $("#control_panel").hover(function(){
 			    $(this).stop().animate({
 				       opacity:"1"
 				        },300);
 			    },function(){
 				             $(this).stop().animate({
 				                  opacity:"0.35"
 			               }, 800);
	        })

      $("#setPoint").click(function(){
        isPointSet = false;//set the start poin by clicking on canvas
      });



      $(window).keydown(function(){ // capture key down and calling button press function
              if(event.which == 87 || event.which == 38 ){ // up arrow & w
                      $("#b_u").stop().mouseover();
                      $("#b_u").click();
              };

              if(event.which == 83 || event.which == 40 ){ // udown arrow & s
                      $("#b_d").stop().mouseover();
                      $("#b_d").click();
              };

              if(event.which == 65 || event.which == 37 ){ // left arrow & a
                      $("#b_l").stop().mouseover();
                      $("#b_l").click();
              };

              if(event.which == 68 || event.which == 39 ){ // right arrow & d
                      $("#b_r").stop().mouseover();
                      $("#b_r").click();
              };
              console.log("pressed:"+ event.which);
              drive(1,1,1,1);
          })

      $(window).keyup(function(){
            if(event.which == 87 || event.which == 38 ){ // up arrow & w
                    $("#b_u").stop().mouseout();
            };

            if(event.which == 83 || event.which == 40 ){ // udown arrow & s
                    $("#b_d").stop().mouseout();
            };

            if(event.which == 65 || event.which == 37 ){ // left arrow & a
                    $("#b_l").stop().mouseout();
            };

            if(event.which == 68 || event.which == 39 ){ // right arrow & d
                    $("#b_r").stop().mouseout();
            };
          })

          /*button press functions */
          $("#b_u").click(function(){
            up();
            console.log("Up");
          });

          $("#b_d").click(function(){
            down();
            console.log("Down");
          });

          $("#b_l").click(function(){
            left();
            console.log("Left");;
          });

          $("#b_r").click(function(){
            right();
            console.log("Right");
          });

          $("#b_s").click(function(){
            if($("#b_s").val() == "Start"){
              $("#b_s").val("Stop");
              begin();
            }else{
              $("#b_s").val("Start");
              end();
            }
            console.log("Control");
          });

  });
  </script>


      <div id = "info">
        <p class="red" >Boston University</p>
        <p class="gray" >GROUP 1, Challenge 8</p>
        <p class="gray" >Pete, Carlos, Hao, Avi, Ying</p>
      <br/>
      </div>
      <div  id="msg"></div>
      <canvas id="myCanvas"  width="1020px" height="420px">
        Your browser does not support the HTML5 canvas tag.</canvas>
      <div class="canvas">
      <p class="ins">Current position: <img id="pos" src="http://hhao.hostei.com/doc/files/CDN/star.png"/>&nbsp;
      Start Point: <img id="pos" src="http://hhao.hostei.com/doc/files/CDN/flag.png"/>&nbsp;
        X:<input id="x" class="input-text" type="text" value="8">&nbsp;
        Y:<input id="y" class="input-text" type="text" value="15">&nbsp;
        <input id="setPoint" class="button" type="submit" value="Set Start Point">&nbsp;
        <img id="picCar" src="http://hhao.hostei.com/doc/files/CDN/car.png" style="vertical-align: middle"/>
      </p>
      </div>
      <div id = "control_panel">
        <img id= "b_u" class="button" src="http://hhao.hostei.com/doc/files/CDN/up.png" alt="up"/><br/>
        <img id= "b_l" class="button" src="http://hhao.hostei.com/doc/files/CDN/left.png" alt="down"/>
        <input id="b_s" class="button" type="submit" value="Start">
        <img id= "b_r" class="button" src="http://hhao.hostei.com/doc/files/CDN/right.png" alt="left"/>
        <img id= "b_d" class="button" src="http://hhao.hostei.com/doc/files/CDN/down.png" alt="right"/><br/>
      </div>

      <div id="monitor">
      </div>

      <img id="layout" src="http://hhao.hostei.com/doc/files/CDN/layout.png" style="display:none;"/>
      <img id="cen" src="http://hhao.hostei.com/doc/files/CDN/cen.png" style="display:none;"/>


  </body>
</html>
